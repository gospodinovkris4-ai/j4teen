<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title data-key="chatPageTitle">Чат – J4Teen</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="topbar">
  <div class="logo">J4Teen</div>
  <button id="lang-toggle" type="button">EN</button>
  <div class="burger">☰</div>

  <div class="menu">
    <a href="index.html" data-key="home">Начало</a>
    <a href="jobs.html" data-key="jobs">Обяви</a>
    <a href="categories.html" data-key="categories">Категории</a>
    <a href="news.html" data-key="newsMenu">Новини</a>
    <a href="pricing.html" data-key="plans">Планове</a>
    <a href="post.html" data-key="post">Публикувай</a>
    <a href="chat.html" data-key="chat">Чат</a>
  </div>
</nav>

<header class="hero small">
  <div class="hero-content">
    <h1 data-key="chatTitle">Чат</h1>
    <p id="chat-job-title" style="opacity:.9;"></p>
  </div>
</header>

<main class="container">

  <div id="chat-box" style="
    max-width:720px;
    margin:20px auto;
    padding:16px;
    background:#f8fafc;
    border-radius:20px;
    box-shadow:0 8px 24px rgba(0,0,0,0.08);
    min-height:280px;
    display:flex;
    flex-direction:column;
    gap:8px;
  "></div>

  <form id="chat-form" style="
    max-width:720px;
    margin:12px auto 24px;
    display:flex;
    gap:10px;
  ">
    <textarea
      id="chat-message"
      data-key-placeholder="chatMsgPh"
      placeholder="Съобщение"
      required
      rows="1"
      style="
        flex:1;
        padding:12px 16px;
        border-radius:999px;
        border:1px solid #d1d5db;
        resize:none;
      "
    ></textarea>

    <button type="submit"
      data-key="chatSend"
      style="
        padding:12px 20px;
        border-radius:999px;
        background:#2563eb;
        color:white;
        font-weight:700;
        border:none;
        cursor:pointer;
      ">
      Изпрати
    </button>
  </form>

</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="main.js"></script>

<script>
  const params = new URLSearchParams(window.location.search);
  const jobId = params.get("jobId");

  const chatKey = "chat_" + jobId;
  const chatBox = document.getElementById("chat-box");
  const chatForm = document.getElementById("chat-form");
  const messageInput = document.getElementById("chat-message");
  const jobTitleEl = document.getElementById("chat-job-title");

  const SUPABASE_URL = "https://aujswymolniwtdxyangf.supabase.co";
  const SUPABASE_KEY = "sb_publishable_UNykLLkp5Jzb9TQlq-qijg_U94miJxS";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let currentUserEmail = "";

  document.addEventListener("DOMContentLoaded", async () => {
    const { data } = await supabase.auth.getUser();
    if (!data.user) {
      window.location.href = "login.html";
      return;
    }

    currentUserEmail = data.user.email;

    const jobs = JSON.parse(localStorage.getItem("jobs") || "[]");
    const job = jobs.find(j => j.id === jobId);

    if (job) {
      jobTitleEl.textContent = "За обява: " + job.title;
    }

    renderChat();
  });

  function renderChat() {
    const messages = JSON.parse(localStorage.getItem(chatKey) || "[]");
    chatBox.innerHTML = "";

    messages.forEach(msg => {
      const isMe = msg.user === currentUserEmail;

      const bubble = document.createElement("div");
      bubble.style.alignSelf = isMe ? "flex-end" : "flex-start";
      bubble.style.maxWidth = "80%";
      bubble.style.background = isMe ? "#2563eb" : "#ffffff";
      bubble.style.color = isMe ? "#ffffff" : "#111";
      bubble.style.padding = "12px 16px";
      bubble.style.borderRadius = "16px";
      bubble.style.boxShadow = "0 2px 8px rgba(0,0,0,0.06)";

      bubble.innerHTML = `
        <div style="font-size:13px;font-weight:700;margin-bottom:4px;">
          ${msg.user}
        </div>
        <div style="white-space:pre-wrap;">${msg.text}</div>
      `;

      chatBox.appendChild(bubble);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
  }

  chatForm.addEventListener("submit", e => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;

    const messages = JSON.parse(localStorage.getItem(chatKey) || "[]");
    messages.push({
      user: currentUserEmail,
      text,
      createdAt: new Date().toISOString()
    });

    localStorage.setItem(chatKey, JSON.stringify(messages));
    messageInput.value = "";
    renderChat();
  });
</script>

</body>
</html>
